<!DOCTYPE html>
<html lang="kr">
    <head>
        <meta charset="UTF-8">
        <title>다이나믹 SQL 파서</title>
    </head>
    <body>
        <h1 class="title">다이나믹 SQL 파서</h1>
        <button id="parseBtn" style="width: 100%; height: 40px;">변환</button>
        <div style="height: 100%;">
            <div style="display: flex; height: 100%;">
            <textarea id="dynamicSQLInput" placeholder="파싱할 다이나믹 쿼리를 여기에 넣어주세요"></textarea>
            <textarea id="parsedSQLInput" placeholder="이 곳에 파싱된 SQL이 출력됩니다" readonly></textarea>
            </div>
        </div>
    </body>

    <style>
        html, body {
            height: 100%;
        }
        .title {
            padding: 20px;
            text-align: center;
        }
        textarea {
            width: 50%;
            overflow: scroll;
        }
    </style>
    <script>
        document.getElementById("parseBtn").addEventListener("click", e => {
            const dynamicSQL = document.getElementById("dynamicSQLInput").value;
            const parsedSQL = document.getElementById("parsedSQLInput");

            const textList = dynamicSQL.split("\n");

            textList.forEach(text => {
                parsedSQL.value += parse(text) + '\n';
            });
        });

        function parse(text) {
            let resultStr = "";
            if(!text.includes("'") || !text.includes(';')) return resultStr;

            const startIdx = text.indexOf("'");
            const endIdx = text.indexOf(";");

            if(text.substring(0, startIdx).includes('--')) return resultStr;

            const substrText = text.substring(startIdx, endIdx).replaceAll("CHR(39)", "''");

            let inStr = false;

            for(let i = 0; i < substrText.length - 1; ++i) {
                switch(substrText[i]) {
                    case "'":
                        if(inStr) {
                            if(substrText[i + 1] == "'") {
                               resultStr += substrText[i++]; 
                            }
                            else inStr = false;
                        }
                        else inStr = true;
                        break;

                    case '|':
                    case ' ':
                        if(inStr) resultStr += substrText[i];
                        break;
                    
                    case '-':
                        if(!inStr && substrText[i+1] == '-') {
                            return resultStr;
                        }
                        break;

                    default:
                        resultStr += substrText[i];
                        break;
                }
            }

            return resultStr;
        }
    </script>
</html>

